name: Test

on:
  push:
    branches-ignore: ["main"]
  pull_request:
    branches: ["main"]

env:
  BUN_VERSION: "1.2.13"
  SKIP_ENV_VALIDATION: true

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: blacksmith-4vcpu-ubuntu-2204

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.FLOWCORE_MACHINE_GITHUB_TOKEN }}
          submodules: true
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Typecheck
        run: bun run typecheck
      - name: Lint
        run: bun run lint
      - name: Format Check
        run: bun run format:check
      - name: Validate Build
        run: bun run build
        env:
          # Standardized dummy environment variables for testing
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test"
          NEXTAUTH_URL: "http://localhost:3000"
          NEXTAUTH_SECRET: "dummy-nextauth-secret-min-32-chars-long"
          USABLE_CLIENT_ID: "dummy-client-id"
          USABLE_CLIENT_SECRET: "dummy-client-secret"
          USABLE_OIDC_ISSUER: "https://dummy.com"
          FLOWCORE_TENANT: "graphable"
          FLOWCORE_DATACORE: "graphable"
          FLOWCORE_WEBHOOK_BASE_URL: "https://dummy.com"
          FLOWCORE_WEBHOOK_API_KEY: "dummy-api-key"
          FLOWCORE_TRANSFORMER_SECRET: "dummy-transformer-secret"








